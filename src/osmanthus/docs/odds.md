Texas Holdem Odds Evaluation
===

Démon de Laplace
---

>我们可以把宇宙现在的状态视为其过去的因以及未来的果。如果一个智能知道某一刻所有自然运动的力和所有自然构成的物件的位置，假如他也能够对这些数据进行分析，那宇宙里最大的物体到最小的粒子的运动都会包含在一条简单公式中。对于这智者来说没有事物会是含糊的，而未来只会像过去般出现在他面前。 -- marquis de Laplace 《Essai philosophique sur les probabilités》

## 概率？

虽然在自然科学中，决定论的市场已经越来越小了，但是在扑克游戏中，我们必须掌握各种情况下，玩家[^1]获胜的概率。  
下文将用C(n, k)来表示从n中取k个数的情况数量，用PI(n, k=x)表示从n连乘到x，变量为k。

## 概率

在德州扑克这种棋牌游戏中，很多情况的概率是可以通过直接计算得到的，主要有两种方法。第一种是找出满足条件的情况数量，然后除以总共可能的情况数量。  
举个例子，开局时手牌（在翻牌发出之前，玩家会先拿到两张手牌，也称口袋牌）拿到一对A共有6种情况：♠A♥A，♠A♦A，♠A♣A，♥A♦A，♥A♣A，♦A♣A；而总共手牌的可能性一共有 C(52, 2) = 1326种  
那么，手牌拿到一对A的概率为 6/1326 ≈ 0.00452  

另一种计算方法是借助于[条件概率](http://en.wikipedia.org/wiki/Conditional_probability)，对于更复杂的情况，我们还得使用[决策树](http://en.wikipedia.org/wiki/Decision_tree)。  
还是上面的例子，52张牌，有4种方式发出一张A，则第一张牌发出A的概率是4/52 = 1/13，第二张发出A的概率是3/51 = 1/17；则起手拿到一对A的概率为1/13 x 1/17 = 1/221。  

一般来说，要想获得概率，就得根据特定问题，选择不同的解决方案，本文将主要讨论一下这些解决方法。

### 只考虑手牌时的情况
---

####只考虑自己的情况

德州扑克中，尚未开出翻牌的时候，自己持有两张手牌，可能性有
<pre>
C(52, 2) = 1,326
</pre>

即从52张牌中抽取2张牌的可能的情况。  

既然在德州扑克中，花色之间并没有相对的一个比较值，那么这个数量可以进行一些缩减。在翻牌前决定手牌大小的因素是牌的阶(rank)以及手牌是否是同一花色。

于是手牌的牌型可以归纳为三类：13个对子；13*12/2个同花；78个杂牌。一共169种可能。

|手牌牌型|牌型总数|每个牌型的花色组合数|总共组合数|特定组合的概率|任意组合的概率|
|:--------:|:-------------:|:-----------------------------:|:-----------|:-----------------:|:------------:|
|对子|13|C(4, 2) = 6|13 x 6 = 78|6/1326 ≈ 0.00452|78/1326 ≈ 0.0588|
|同花|78|C(4, 1) = 4|78 x 4 = 312|4/1326 ≈ 0.00302|312/1326 ≈ 0.2353|
|杂牌|78|C(4, 1) x C(3, 1) = 12|78 x 12 = 936|12/1326 ≈ 0.00905|936/1326 ≈ 0.7059|

####考虑有对手的情况

只有一个对手的情况  
玩家已经有两张手牌了，剩余的牌数为50张  
那么对手的手牌情况的可能性有  

<pre>
C(50, 2) = 1,225
</pre>

很简单，类似的  
当对手有两个的时候  
<pre>
C(50, 2) * C(48, 2) = 1,381,800
</pre>

但是考虑到当对手的手牌是♠A♥J和♥8♣8，和♥8♣8与♠A♥J的时候，情况实际上是一样的，所以可能性应该是  

<pre>
C(50, 2) * C(48, 2) / 2! = 690,900
</pre>

考虑三个对手的情况  
<pre>
C(50, 2) * C(48, 2) * C(46, 2) / 3! = 238,360,500
</pre>

这样，我们得到当有n个对手时的情况
<pre>
H = PI(n, k=1)(52-2k, 2) / n!
或
H = C(50, 2n) * (2n - 1)!!
</pre>

其中**15!!**表示15的[**双阶乘**](http://en.wikipedia.org/wiki/Double_factorial)，例如5!! = 5 * 3 * 1 = 15; 8!! = 8 * 6 * 4 * 2 = 384

|Opponents|Number of possible hand combinations|
|:-------:|:-----------------------------------|
|1|1,225                                       |
|2|690,900                                     |
|3|238,360,500                                 |
|4|56,372,258,250                              |
|5|≈9.7073x10^12 (more than 9 trillion)        |
|6|≈1.2620x10^15 (more than 1 quadrillion)     |
|7|≈1.2674x10^17 (more than 126 quadrillion)   |
|8|≈9.9804x10^18 (almost 10 quintillion)       |

对德州扑克的一个穷举分析如下。  
包括玩家在内一共9人。

<pre>
169 * C(50, 16) * 15!! * C(34, 5) ≈ 4.693329e+26
自己手牌可能 * 对手手牌可能 * 公共牌可能
</pre>

**4.693329e+26**，将近500[Septillion](http://en.wikipedia.org/wiki/Septillion)种可能性，假设我们能够在1秒钟内完成对1万亿(10^12)种牌局的胜负评估，我们仍然需要1千500万年才能得出最终的结论。虽然我们可以通过一些剪枝算法来减少需要评估的组合数量，但是这个数还是远远地超出了能够暴力穷举的范围。  
因此，绝大多数的软件都是通过模拟成千上万场牌局来得到手牌的期望值和统计学意义上的概率的。  
([蒙特卡罗法](http://en.wikipedia.org/wiki/Monte_Carlo_method))。

####下风牌(Dominated hands)

在评估翻牌前的手牌时，了解手牌在什么情况下是处于下风[dominated](http://en.wikipedia.org/wiki/Domination_%28poker%29)是很有帮助的。  
下风牌是很可能被其他更具优势的手牌击败的手牌。通常情况下，下风牌只有一张牌(无论花色)能够帮助提升，从而击败上风牌(不包括顺子和同花)。  
举个例子，比起KQ而言，KJ是下风牌，[起脚牌](http://en.wikipedia.org/wiki/Kicker_%28poker%29)Q击败了起脚牌J。除了顺子和同花，KJ需要桌上出现另一张J才能逆转KQ，（如果桌上出现的是QJ的话，KJ仍然会输掉）。低阶的对子手牌相对于高阶的对子手牌而言是下风牌。

#####口袋牌

除去顺子和同花，对子手牌至少需要组成三条才能逆转更高阶的对子手牌。请参考["翻牌"](#AFTER_THE_FLOP)一节中对对子手牌提升至三条的概率分析。  

为了计算对手有更高阶对子的概率，先考虑只有一个对手时候的情况。对手持有更好的对子的概率可以表述为：发给对手的第一张牌比玩家的对子的阶要高，然后获得另一张同阶的牌组成对子的概率。令r等于对子手牌的阶（值为2-10，对于J-A而言，值为11-14），比r阶高的牌一共有(14-r)*4张。52张牌减去发给玩家的两张对子还剩50张。那么对手得到比玩家更高阶的对子的概率为：

<pre>
P = (14 - r) * 4/50 * 3/49 = (84 - 6r)/1225
</pre>

下面的方法扩展到计算多个对手获得比玩家更高阶对子手牌的概率。  
1. 将单个对手获得特定阶的对子的基础概率乘以对手的数量。  
2. 减去当有多个对手**均**拿到高阶对子的调整概率（这一步是必须的，因为这个概率在上一步计算时实际上已经被多次叠加了）。

令n等于对手的个数，Pma为多个对手持有更高的对子的调整概率，则多个对手中至少有一个人持有比玩家更高阶的对子的概率为：  

<pre>
P = (84 - 6r)/1225 * n - Pma = (n(84 - 6r) - 1225Pma)/1225
</pre>

Pma的计算取决于玩家对子手牌的阶，但是可以归纳为：

<pre>
Pma = P2 + 2P3 + … + (n-1)Pn,
</pre>

其中，P2为两个对手均持有更高阶对子的概率，P3为三个对手均持有更高阶对子的概率，依此类推。特别的，当玩家拿着一对2，场上有9个对手的情况下[^2]，P4 < 0.0015，P5 < 0.00009，于是计算P2和P3就已经能够提供比较精确的结果了。  

下面的表格给出了翻牌之前有一个对手拿到比玩家的对子更大的对子的概率  

|持有以下对子,有一个对手更大的概率|1个对手|2个对手|3个对手|4个对手|5个对手|6个对手|7个对手|8个对手|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|KK|0.0049|0.0098|0.0147|0.0196|0.0244|0.0293|0.0342|0.0391|
|QQ|0.0098|0.0195|0.0292|0.0388|0.0484|0.0579|0.0673|0.0766|
|JJ|0.0147|0.0292|0.0436|0.0577|0.0717|0.0856|0.0992|0.1127|
|1010|0.0196|0.0389|0.0578|0.0764|0.0946|0.1124|0.1299|0.1470|
|99|0.0245|0.0484|0.0718|0.0946|0.1168|0.1384|0.1593|0.1795|
|88|0.0294|0.0580|0.0857|0.1125|0.1384|0.1634|0.1873|0.2101|
|77|0.0343|0.0674|0.0994|0.1301|0.1595|0.1874|0.2138|0.2387|
|66|0.0392|0.0769|0.1130|0.1473|0.1799|0.2104|0.2389|0.2651|
|55|0.0441|0.0862|0.1263|0.1642|0.1996|0.2324|0.2623|0.2892|
|44|0.0490|0.0956|0.1395|0.1806|0.2186|0.2532|0.2841|0.3109|
|33|0.0539|0.1048|0.1526|0.1967|0.2370|0.2729|0.3040|0.3300|
|22|0.0588|0.1141|0.1654|0.2124|0.2546|0.2914|0.3222|0.3464|

下面的表格给出了翻牌之前有多个对手的对子比玩家更大的概率  
其中Pm = P2 + P3 + … + Pn.  

|持有以下对子,有多个对手更大的概率|2个对手|3个对手|4个对手|5个对手|6个对手|7个对手|8个对手|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|KK|< 0.00001|0.00001|0.00003|0.00004|0.00007|0.00009|0.00012|
|QQ|0.00006|0.00018|0.00037|0.00061|0.00091|0.00128|0.00171|
|JJ|0.00017|0.00051|0.00102|0.00171|0.00257|0.00360|0.00482|
|1010|0.00033|0.00099|0.00200|0.00335|0.00504|0.00709|0.00950|
|99|0.00054|0.00164|0.00330|0.00553|0.00836|0.01177|0.01580|
|88|0.00081|0.00244|0.00493|0.00828|0.01253|0.01769|0.02378|
|77|0.00112|0.00341|0.00689|0.01160|0.01758|0.02487|0.03351|
|66|0.00149|0.00454|0.00918|0.01550|0.02353|0.03335|0.04503|
|55|0.00191|0.00583|0.01182|0.01998|0.03040|0.04318|0.05840|
|44|0.00239|0.00728|0.01480|0.02506|0.03821|0.05438|0.07371|
|33|0.00291|0.00890|0.01812|0.03075|0.04698|0.06699|0.09099|
|22|0.00349|0.01068|0.02180|0.03706|0.05673|0.08107|0.11034|

###翻牌
<a id="AFTER_THE_FLOP"></a>

---

###参考
- - -
1. [常见德州扑克术语](http://wenku.baidu.com/view/f8d7241b59eef8c75fbfb3be.html)  
2. [wiki百科原文](http://en.wikipedia.org/wiki/Poker_probability_%28Texas_hold_%27em%29)

###注释
[^1]:下文中玩家用于区分其他参与牌局的人，计算获胜概率都是针对这一个人而言的，尽管这在客观性上会造成一定的混淆，但是就数学概率的公平性而言是一致的。
[^2]:此处需要计算8个对手的情况，由于准备尚未充分，暂时搁置。
